{% load staticfiles %}
<!DOCTYPE html PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<html>
<head>
<meta charset="utf-8" />
<title>canvas test</title>
<script src="{% static 'frontend/js/jquery-latest.js' %}"></script>
<script type="text/javascript">
var t = 0;                      //标记当前处理到的位置
var size= 1;                   //存储当前尺寸
var point = [];
var m = 1;                      //ps
var u = 0;                           //标记位数
var wr = 0;                          //标记开端,有括号才计入数据
var cr = 0;                         //标记是逗号后面的数据
var num = [0,0,0,0,0];
var num1 = [0,0,0,0,0];
var num2 = [0,0,0,0,0];
var sum_num = 0;                     //运算中的累加值，横坐标
var sum_num1 = 0;                    //运算中的累加值，纵坐标
var sum_num2 = 0;
var select = 0;                      //是否进入拖拽类型，0 代表不是
var initial_x = 0;                   //初始位置
var initial_y = 0;
var final_x = 0;                     //拖放后的终止位置
var final_y = 0;
var _x=0;
var _y=0;
var ox=0;
var oy=80;
//var datas = [];
var color = ['#000','#004','#008','#00c','#040','#044','#048','#04c','#080','#084','#088','#08c','#0c0','#0c4','#0c8','#0cc','#400','#404','#408','#40c','#440','#444','#448','#44c','#480','#484','#488','#48c','#4c0','#4c4','#4c8','#4cc','#800','#804','#808','#80c','#8c0','#8c4','#8c8','#8cc','#cc0','#cc4','#cc8','#ccc','#840','#844','#848','#84c','#880','#884','#888','#88c','#c00','#c04','#c08','#c0c','#c40','#c44','#c48','#c4c','#c80','#c84','#c88','#c8c'];
var hr;

var res; 
var len;
var i;
var j;
var k,l;
var cwidth;
var cheight;
var ndevice;
var npath;
var devices;
var paths,pfc;//paths for control
var line,lines;
var backdevices;
var backpaths;
var backpfc;
//回调函数 Control Layer
function callback_control() 
{  
	getbackcontrol();
    //接收响应数据  
    //判断对象状态是否交互完成，如果为4则交互完成  
    //alert("Come in call back control");
    if(hr.readyState == 4) {  
         //判断对象状态是否交互成功,如果成功则为200  
        if(hr.status == 200) {  
            //接收数据,得到服务器输出的纯文本数据  
            res = eval(hr.responseText); 
            //alert("Receive Data" + res); 
            //得到div的节点将数据显示在div上  
            //alert(res.length);
            len = res.length;
            i = 0;
            cwidth = 0;
            cheight = 0;
            npath = 0;
            pfc = [];
           // alert(res[2]+"hshs");
            while(i<len)
            {
            	line = res[i].replace(/(\n)+|(\r\n)+/g, "").split(" ");
            	//alert(line);
            	if(i == 0)
            	{
            		cwidth = line[0];
            		cheight = line[1];
            		i=i+1;
            	}
            	else if(i == 1)
            	{
            		 npath = Number(line[1]);
            		 i=i+1;
            	}
            	else
            	{
            		//alert(line[0]+line[1]+line[2]+line[3]+line[4]);//最后一个是空格 --11.7hss
            		for(j = 0; j < npath; j++)
            		{
                            for (k=1; k<line.length-1;k++) {
                                lines=line[k].substr(1,line[k].length-2).split(",");//横纵坐标 --11.7hss
                                pfc.push(lines[0]);
                                pfc.push(lines[1]);
                                pfc.push(j);
                                }
                                if(j<npath-1){
                                line = res[j+3].replace(/(\n)+|(\r\n)+/g, "").split(" ");}
            		}
                i = i + npath;
            	}
            	
            }

var canvas = document.getElementById('canvas');
            Tian_chong(canvas);
            //var divresult = document.getElementById("canvas");  
            //divresult.innerHTML = res;  
        }  
    }  
}

//回调函数 FLow Layer
function callback_flow() 
{  
    //接收响应数据  
    //判断对象状态是否交互完成，如果为4则交互完成  
    if(hr.readyState == 4) {  
         //判断对象状态是否交互成功,如果成功则为200  
        if(hr.status == 200) {  
            //接收数据,得到服务器输出的纯文本数据  
            res = eval(hr.responseText); 
            //得到div的节点将数据显示在div上  
            len = res.length;
            i = 0;
            j = 0;
            cwidth = 0;
            cheight = 0;
            ndevice = 0;
            npath = 0;
            devices = [];
            paths = [];
            line = [];
            while(i<len)
            {
            	line = res[i].replace(/(\n)+|(\r\n)+/g, "").split(" ");
            	if(i == 0)
            	{
            		cwidth = Number(line[0]);
            		cheight = Number(line[1]);
            		i=i+1;
            	}
            	else if(i == 1)
            	{
            		ndevice = Number(line[1]);
            		if(ndevice < 1)alert("Number of devices error!");
            		else
            			{                                           //draw modules here 11.14 --hss
            				for(j = 0; j < ndevice; j++)
            				{
            					line = res[i+j+1].replace(/(\n)+|(\r\n)+/g, "").split(" ");
            					devices.push(line);
            				}
            				i = i+ndevice+1;
            				var pb = ndevice + 2;
            			}
            	}
            	else if(i == pb)
            	{
            		line = res[i].replace(/(\n)+|(\r\n)+/g, "").split(" ");
            		npath = Number(line[1]);
            		for(j = 0; j < npath; j++)
            		{
                	line = res[i+j+1].replace(/(\n)+|(\r\n)+/g, "").split(" ");
                        for (k=1; k<line.length-1;k++) {
                                lines=line[k].substr(1,line[k].length-2).split(",");
                                paths.push(lines[0]);
                                paths.push(lines[1]);
                                paths.push(j);
}
            		}
            		i = i+npath+1;
            	}
            }
	    getbackdevice();
	    getbackflow();
            Tian_chong(document.getElementById('canvas2'));
            //var divresult = document.getElementById("canvas");  
            //divresult.innerHTML = res;  
        }  
    }  
}
function getbackdevice()
{
 $.ajax({
        type:"GET",
        url:"/site/backdevice/",
        data:{"num":"sdsd"},
        dataType: "json",  
        //type: "POST",  
        //traditional: true,
	async :false,
        success: function(data) {
	      	var rr = JSON.stringify(data); 
		//alert(typeof rr);
		var d =rr.split(",");
		backdevices = []; 
		var ff = d[0].split("[");
		backdevices.push(parseInt(ff[1]));
		var pt=1;
		while(pt<d.length-1)
		{	
			//alert(d[pt]);
			backdevices.push(parseInt(d[pt]));
			pt=pt+1;
		}
		ff = d[d.length-1].split("]");
		backdevices.push(parseInt(ff[0]));
        }
      });
}
function getbackflow()
{
 $.ajax({
        type:"GET",
        url:"/site/backflow/",
        data:{"num":"sdsd"},
        dataType: "json",  
        //type: "POST",  
        //traditional: true,
        async :false,
        success: function(data) {
                var rr = JSON.stringify(data); 
                //alert(typeof rr);
		//alert("rrrr");
		//alert(data);
                var d =rr.split(",");
                backpaths = []; 
                var ff = d[0].split("[");
                backpaths.push(parseInt(ff[1]));
                var pt=1;
                while(pt<d.length-1)
                {       
                        //alert(d[pt]);
                        backpaths.push(parseInt(d[pt]));
                        pt=pt+1;
                }
                ff = d[d.length-1].split("]");
                backpaths.push(parseInt(ff[0]));
        }
      });
}

function getbackcontrol()
{
 $.ajax({
        type:"GET",
        url:"/site/backcontrol/",
        data:{"num":"sdsd"},
        dataType: "json",  
        //type: "POST",  
        //traditional: true,
        async :false,
        success: function(data) {
                var rr = JSON.stringify(data); 
                var d =rr.split(",");
                backpfc = []; 
                var ff = d[0].split("[");
                backpfc.push(parseInt(ff[1]));
                var pt=1;
                while(pt<d.length-1)
                {       
                        backpfc.push(parseInt(d[pt]));
                        pt=pt+1;
                }
                ff = d[d.length-1].split("]");
                backpfc.push(parseInt(ff[0]));
        }
      });
}
function flow_layer(para)
{
	if(para.checked){
		/*hr = new XMLHttpRequest();
		hr.onreadystatechange = callback_flow;
		hr.open("GET", "/site/flow/");
    		hr.send();*/
		//var res = hr.responseText;
		getbackdevice();
		getbackflow();
		if((backpaths==null)||(backdevices==null))
		{
			alert("您尚未上传有效的资源文件或所上传的文件无效，请上传后重试");
		}
		else
		{
			var canvas = document.getElementById('canvas2');
			Tian_chong(canvas);
		}
	}
	else{//checkbox is unchecked
		document.getElementById('canvas2').getContext('2d').clearRect(0,0,850,520);
	}
}

function control_layer(para)
{
	if(para.checked){
		/*hr = new XMLHttpRequest();
		hr.onreadystatechange = callback_control;
		hr.open("GET", "/site/control/");
		hr.send();*/
		//point=paths;
		//Tian_chong();
		//var res = hr.responseText;
		getbackcontrol();
		if(backpfc==null)
		{
			alert("您尚未上传有效的资源文件，请上传后重试");
		}
		else
		{		
			getbackcontrol();
			var canvas = document.getElementById('canvas');
			Tian_chong(canvas);
		}
}
	else{//checkbox is unchecked
		document.getElementById('canvas').getContext('2d').clearRect(0,0,850,520);
	}
}
function doNothing()
{
    window.event.returnValue=false;
    return false;
}

function init()
{
    window.document.onmousedown = mouseDown;
    window.document.onmouseup = mouseUp;
}


function fileSelected() {
    var file = document.getElementById('file').files[0];
    if (file) {
        var fileSize = 0;
        if (file.size > 1024 * 1024)
            fileSize = (Math.round(file.size * 100 / (1024 * 1024)) / 100).toString() + 'MB';
        else
            fileSize = (Math.round(file.size * 100 / 1024) / 100).toString() + 'KB';

        document.getElementById('fileName').innerHTML = 'Name: ' + file.name;
        document.getElementById('fileSize').innerHTML = 'Size: ' + fileSize;
        document.getElementById('fileType').innerHTML = 'Type: ' + file.type;
    }
}


function upload() {/*9.26 cmy*/
    var fd = new FormData();
    fd.append("file", document.getElementById('file').files[0]);
    var xhr = new XMLHttpRequest();
    xhr.upload.addEventListener("progress", uploadProgress, false);
    xhr.addEventListener("load", uploadComplete, false);
    xhr.addEventListener("error", uploadFailed, false);
    xhr.addEventListener("abort", uploadCanceled, false);
    xhr.open("POST", "UploadMinimal.aspx");
    xhr.send(fd);
}

function uploadProgress(evt) {/*9.26 cmy*/
    if (evt.lengthComputable) {
        var percentComplete = Math.round(evt.loaded * 100 / evt.total);
        document.getElementById('progressNumber').innerHTML = percentComplete.toString() + '%';
    }
    else {
        document.getElementById('progressNumber').innerHTML = 'unable to compute';
    }
}

function uploadComplete(evt) {/*9.26 cmy*/
    /* This event is raised when the server send back a response */
    alert(evt.target.responseText);
}

function uploadFailed(evt) {/*9.26 cmy*/
    alert("There was an error attempting to upload the file.");
}

function uploadCanceled(evt) {/*9.26 cmy*/
    alert("The upload has been canceled by the user or the browser dropped the connection.");
}




function mouseDown(event)
{
    var e = event || window.event;
    var value = e.button;
    if(value != 0)
    {   e.preventDefault();
        //alert(value);
    }
    else
    {
        if(select== 0 ){
             if((e.clientX>0)&&(e.clientY>92)&&(e.clientY<642)&&(e.clientX<1348))
            {
                   _x=e.clientX;
                   _y=e.clientY;
            }
        }//select=0,no drag
        else
        {
                       if((e.clientX>0)&&(e.clientY>92)&&(e.clientY<642)&&(e.clientX<1348))
            {
                var scrollX = document.documentElement.scrollLeft || document.body.scrollLeft;
                var scrollY = document.documentElement.scrollTop || document.body.scrollTop;
                initial_x = (e.pageX || e.clientX) + scrollX - 12;
                initial_y = (e.pageY || e.clientY) + scrollY - 12;
            }
        }
    }
}
function mouseUp(event)
{
    var e=event || window.event;
    var value=e.button;
    var scrollX = document.documentElement.scrollLeft || document.body.scrollLeft;
    var scrollY = document.documentElement.scrollTop || document.body.scrollTop;
    if(value != 0)
    {   e.preventDefault();}
    else
    {
        if (select!=0){

//alert(e.clientX+"a"+e.clientY);
            if((e.clientX>0)&&(e.clientY>92)&&(e.clientY<642)&&(e.clientX<1348))
            {
                final_x = (e.pageX || e.clientX) + scrollX-12;
                final_y = (e.pageY || e.clientY) + scrollY-12;
                if(final_x!=initial_x||final_y!=initial_y){//9.19 确保单击不会引起变化 --hss
                    //alert(hs1+"hshs"+hs2);
                    _x=initial_x-ox;
                    _y=initial_y-oy;
                    var _t=_x%(5*size);
                    var _m=(_x-_t)/(5*size);
                    var xasis = _m;//x的实际坐标,shx said -2
                    _t = _y%(5*size);
                    _m = (_y-_t)/(5*size);
                    var yasis = _m;                           //得到y的实际坐标
var num=0;                                //存储当前点的标号
                    var tol=point.length;
                    var qk=[];                               //存储坐标符合的数组
                    var qt = 0;                                  //标记是否为空
                    var pid = 0
                    var nid = 0;
                    while (num<tol)
                    {
                        if(Math.abs(point[num]-xasis)<2)
                        {
//alert(yasis);
                            if(Math.abs(point[num+1]-yasis)<2)
                            {
                                pid = point[num+2];
                                qt = 1;
                                nid = num;
                            }
                        }
                        num=num+3;                               //pid存储当前ps值，好好利用
                    }                                            //nid中存储了在数组中的标号，好好利用
//alert(xasis+"heng"+yasis);                   
 if (qt == 0){

alert("sorry,but you haven't selected any ps");
return;
}
                    var _x1 = final_x-ox;
                    var _y1 = final_y-oy;
                    var _t1 = _x1%(5*size);
                    var _m1 = (_x1-_t1)/(5*size);
                    var xasis1 = _m1;                            //得到x的实际坐标
                    _t1 = _y1%(5*size);
                    _m1 = (_y1-_t1)/(5*size);
                    var yasis1 = _m1;
                    if(select==1){
                        var width_x = xasis1-xasis;
                        var width_y = yasis1-yasis;
                        var num1=0;                                //存储当前点的标号
                        var tol1=point.length;
                        var new_id;
                        var new_id1;
                        while (num1<tol1)
                        {
                            if(point[num1+2]==pid)
                            {
                                point[num1]=point[num1]+width_x;
                                point[num1+1]=point[num1+1]+width_y;
                            }
                            num1=num1+3;
                        }
                        Tian_chong();
                    }
                    else//select!=1
                    {
                        new_id=6
                        while(point[nid-new_id*3+2]!=pid)
                        {
                            new_id=new_id-1;
                        }
                        new_id1=6
                        while(point[nid+new_id1*3+2]!=pid)
                        {
                            new_id1=new_id1-1;
                        }
                        var source_x=point[nid-new_id*3];
                        var source_y=point[nid-new_id*3+1];
                        var termin_x=point[nid+new_id1*3];
                        var termin_y=point[nid+new_id1*3+1];
                        var point_tmp = [];

                        var tmp_id=0;
                        while(tmp_id <  nid-new_id * 3)
                        {
                            point_tmp.push(point[tmp_id]);
                            point_tmp.push(point[tmp_id+1]);
                            tmp_id = tmp_id+3;
                        }
                        tmp_id = nid-new_id*3;
                        while(tmp_id <nid+new_id1*3)
                        {
                            point_tmp.push(point[tmp_id]);
                            point_tmp.push(point[tmp_id+1]);
                            tmp_id = tmp_id+3;
                        }
                        tmp_id = nid+new_id1*3+3;
                        //alert(tmp_id);
                        var tol2=point.length;
                        //alert(tol2);
                        //alert(point_tmp);
                        while(tmp_id <tol2)
                        {
                            point_tmp.push(point[tmp_id]);
                            point_tmp.push(point[tmp_id+1]);
                            tmp_id = tmp_id+3;
                        }
                        $.ajax({
                            type:"POST",
                            url:"/site/eee/",
                            async :false,
                            data:{num:source_x,num1:source_y,num2:termin_x,num3:termin_y,num4:xasis1,num5:yasis1,num6:point_tmp},
                            dataType:"json",
                            traditional: true,
                            success: function(data) {
                                //alert(point_tmp);
                                var datat=data
                                var tol = datat.length;
                                // if (tol<2)
                                // {   alert("no compatiable route!");}
                                // else{
                                //	alert("compatiable"+tol);
                                var i = 0;                       //存储标号
                                var qt = 0;                     //存储类型
                                var new_point = [0,0,0,0,0];              //暂存数组
                                var cunshu = [];                 //总体数组
                                var u=0;
                                while (i<tol)
                                {
                                   //alert(datat[i]);
                                    // alert('y');
                                    if (datat[i]=='(')
                                    {
                                        qt=1;
                                        i=i+1;
                                    }
                                    else if(datat[i]=='?')
                                    {  if(qt==1){
                                        var tu=0;
                                        var sump=0;
                                        while(tu<u)
                                        {
                                            sump+=new_point[tu]*(Math.pow(10,u-tu-1));
                                            tu=tu+1;
                                        }
                                        cunshu.push(sump);}
                                        //alert(sump);
                                        i=i+1;
                                        u=0;
                                    }
                                    else if ((datat[i]>='0')&&(datat[i]<='9'))
                                    {   //alert(Number(datat[i]));
                                        if(qt==1){new_point[u]=Number(datat[i]);
                                            u=u+1;}
                                        i=i+1;
                                   }
                                    else if (datat[i]==')')
                                    {  if(qt==1){
                                        var tu=0;
                                        var sump=0;
                                        while(tu<u)
                                        {
                                            sump+=new_point[tu]*(Math.pow(10,u-tu-1));
                                            tu=tu+1;
                                        }
                                        cunshu.push(sump);
                                      //alert(sump);
                                        cunshu.push(pid);
                                        qt=0;}
                                        i=i+1;
                                        u=0;
                                    }

                                }
                                var pouint=[];
                                var len1=point.length;
                                var start1=0;
                                while(start1<nid-new_id*3)
                                { pouint.push(point[start1]);pouint.push(point[start1+1]);pouint.push(point[start1+2]);start1=start1+3;
                                }
                                var start=nid-new_id*3;
                                var start2=0;
                                while(start2<cunshu.length)
                                {
                                    pouint.push(cunshu[start2]);
                                    pouint.push(cunshu[start2+1]);
                                    pouint.push(cunshu[start2+2]);
                                    start2=start2+3;
                                }
                                var start3=nid+new_id1*3-3;
                                while(start3<len1){
                                    pouint.push(point[start3]);
                                    pouint.push(point[start3+1]);
                                    pouint.push(point[start3+2]);
                                    start3=start3+3;
                                }
                                point =[];
                                point =pouint;
                                Tian_chong();
                                //}
                            }
                        });
                    }
                }
            }
        }

        else{//select==0
             if((e.clientX>0)&&(e.clientY>92)&&(e.clientY<642)&&(e.clientX<1348)){//10.8 坐标下移  --hss
                //final_x=(e.pageX||e.clientX)+scrollX - 12;
                //final_y=(e.pageY||e.clientY)+scrollY - 92;
                  final_x=e.clientX;
                  final_y=e.clientY;
                var hs1=final_x-_x;
                var hs2=final_y-_y;
                ox=ox+hs1;
                oy=oy+hs2;
               if(ox<=0&&oy<=0&&ox>=-850*(size-1)&&oy>=-520*(size-1)){       //11.15 --hss 
                    document.getElementById('canvas2').getContext('2d').clearRect(0,0,850,520);
                    document.getElementById('canvas2').getContext('2d').translate(hs1,hs2);

                    document.getElementById('canvas').getContext('2d').clearRect(0,0,850,520);
                    document.getElementById('canvas').getContext('2d').translate(hs1,hs2);

 if(document.getElementsByName("11")[0].checked){
            Tian_chong(document.getElementById('canvas2'));
}
 if(document.getElementsByName("12")[0].checked){
            Tian_chong(document.getElementById('canvas'));
 }
//document.getElementById('cv').style.left=hs1+"px";
//document.getElementById('cv').style.top=hs2+"px";
//}
                }
                else{
                    ox=ox-hs1;
                    oy=oy-hs2;
                }



            }
        }
    }
}

function zoomout()//10.3 缩小时原点变化
{
    size = size-1;
   /* if(ox<-850*(size-1)){
    		ctx.translate(-1250*(size-1)-ox,0);
    		ox=-850*(size-1);
    		}
    if(oy<=-520*(size-1)){
	      ctx.translate(0,-520*(size-1)+80-oy);
	      oy=-520*(size-1)+80;
	      } */


 if(document.getElementsByName("11")[0].checked){

 document.getElementById('canvas2').getContext('2d').clearRect(0,0,850,520);
            Tian_chong(document.getElementById('canvas2'));
 }
 if(document.getElementsByName("12")[0].checked){

 document.getElementById('canvas').getContext('2d').clearRect(0,0,850,520);
            Tian_chong(document.getElementById('canvas'));
 }
}

function zoomin()
{
    size = size+1;
//alert(document.getElementsByName("11"));
 if(document.getElementsByName("11")[0].checked){

 document.getElementById('canvas2').getContext('2d').clearRect(0,0,850,520);
            Tian_chong(document.getElementById('canvas2'));
 }
 if(document.getElementsByName("12")[0].checked){

 document.getElementById('canvas').getContext('2d').clearRect(0,0,850,520);
            Tian_chong(document.getElementById('canvas'));
 }
}

function Tian_chong(can)//11.15 --hss
{
	var ctx = can.getContext('2d');  // 获取 2D 渲染上下文^M
	alert(backdevices);
	if(can.id=="canvas2"){
		ctx.fillStyle="#0F9217";                 
		var mk = 0;
		while(mk<backdevices.length){
			ctx.fillRect(backdevices[mk+1]*8*size,backdevices[mk+2]*8*size,backdevices[mk+3]*8*size,backdevices[mk+4]*8*size);
			mk=mk+5;
		}
//		point=paths;
		point=backpaths;
	}
	else
	{
//		point=pfc;
		point = backpfc;
	}
    	var res = 3;
    	var count = point.length;
    	var nodeArray = [];
    	nodeArray.push(point[0]);
    	nodeArray.push(point[1]);
    	nodeArray.push(point[2]);
	while(res<count)
	{
        	if(((point[res-3]==point[res])&&(point[res]==point[res+3]))||((point[res-2]==point[res+1])&&(point[res+1]==point[res+4]))){   //三个点不是一条直线
		}
        	else{
            		nodeArray.push(point[res]);
            		nodeArray.push(point[res+1]);
            		nodeArray.push(point[res+2]);
        	    }
        	res=res+3;
	}	

	var nodeCount = nodeArray.length;
	ctx.beginPath();
	for(res=0;res<=nodeCount;res=res+3)
	{
        	var ps = nodeArray[res+2];
        	ctx.strokeStyle= color[(ps%64)];
        	if((nodeArray[res-1]!=nodeArray[res+2]) && res>0){
        		ctx.closePath();
        		ctx.beginPath();
        	}
        	ctx.lineTo(nodeArray[res]*8*size,nodeArray[res+1]*8*size);
        	ctx.lineWidth=4;
        	ctx.stroke();
	}	
}

function uploaddialog(){/*10.7 cmy*/


    document.getElementById('overlay').style.display="block";

}

function closedialog(){/*10.8 cmy*/

    document.getElementById('overlay').style.display="none";

}
function drag()
{
    if(select==1)
    {
        alert("请关闭 设计我的ps 开关，防止拖动整个ps");
    }
    else if(select==0)
    {
        select=2;//拖动局部
        document.getElementById("cv").style.cursor="default";
//alert(document.getElementById("dr").fill);        
document.getElementById("dr").setAttribute('d','M17 2l-10 10-4-4-3 3 8 8 13-13z');
    }
    else
    {
        select=0;
        document.getElementById("cv").style.cursor="move";
        document.getElementById("dr").setAttribute("d","M17 8c-0.412 0-0.794 0.125-1.113 0.339-0.274-0.779-1.016-1.339-1.887-1.339-0.412 0-0.794 0.125-1.113 0.339-0.274-0.779-1.016-1.339-1.887-1.339-0.364 0-0.706 0.098-1 0.269v-3.269c0-1.103-0.897-2-2-2s-2 0.897-2 2v7.373l-1.346-2.333c-0.261-0.475-0.687-0.813-1.199-0.953-0.499-0.136-1.018-0.064-1.462 0.202-0.907 0.544-1.253 1.774-0.77 2.742 0.030 0.061 0.668 1.368 2.66 5.35 0.938 1.875 1.967 3.216 3.059 3.984 0.857 0.603 1.449 0.634 1.559 0.634h5c0.848 0 1.632-0.245 2.331-0.73 0.676-0.468 1.259-1.152 1.734-2.033 0.939-1.743 1.435-4.246 1.435-7.237 0-1.103-0.897-2-2-2zM16.685 16.763c-0.549 1.021-1.548 2.237-3.185 2.237h-4.99c-0.039-0.003-0.46-0.050-1.095-0.525-0.633-0.474-1.605-1.472-2.638-3.54-2.027-4.054-2.65-5.331-2.656-5.343-0.001-0.002-0.001-0.003-0.002-0.004-0.251-0.503-0.073-1.162 0.389-1.439 0.208-0.125 0.451-0.158 0.685-0.095 0.249 0.068 0.458 0.236 0.587 0.472 0.002 0.003 0.004 0.007 0.006 0.010l1.561 2.705c0.319 0.583 0.678 0.828 1.067 0.729 0.39-0.099 0.587-0.489 0.587-1.157v-7.812c0-0.551 0.449-1 1-1s1 0.449 1 1v6.5c0 0.276 0.224 0.5 0.5 0.5s0.5-0.224 0.5-0.5v-1.5c0-0.551 0.449-1 1-1s1 0.449 1 1v1.5c0 0.276 0.224 0.5 0.5 0.5s0.5-0.224 0.5-0.5v-0.5c0-0.551 0.449-1 1-1s1 0.449 1 1v1.5c0 0.276 0.224 0.5 0.5 0.5s0.5-0.224 0.5-0.5v-0.5c0-0.551 0.449-1 1-1s1 0.449 1 1c0 2.826-0.455 5.165-1.315 6.763z");
    }
}

function adapt()
{
    $.ajax({
        type:"POST",
        url:"/site/fff/",
        data:{"num":point},
        dataType: "json",
        //type: "POST",
        traditional: true,
        success: function(data) {
            alert(data);
        }
    });
}
function upfile()
{
    document.getElementById("formid").submit();
}
function upfile1()
{
    document.getElementById("formid1").submit();
}
function undo()
{
    var str_for_post="hello";
    $.ajax({
        type:"POST",
        url:"/site/ggg/",
        data:{"num":str_for_post},
        dataType: "json",
        //type: "POST",
        traditional: true,
        success: function(data) {
//alert(data);
            point =[];
            var ts1=0;
            var datas = data;
            var s1 = data.length;
            var wr1 =0 ;
            if(datas[2]=="#")
            {
                alert("没有可返回的ps!");
            }
            else{
                var numnew = 0;
                while(ts1<s1)
                {
                    if (datas[ts1]=="(")
                    {wr1 = 1;}
                    else if (datas[ts1]=='?')
                    {
                        point.push(numnew);
                        numnew=0;
                        wr1=2;
                    }
                    else if (datas[ts1]=='!')
                    {
                        point.push(numnew);
                        //alert(numnew);
                        numnew=0;
                        wr1=3;
                    }
                    else if(datas[ts1]==')')
                    {
                        point.push(numnew);
                        numnew=0;
                        wr1=0;
                    }
                    else if ((Number(datas[ts1])>=0) && (Number(datas[ts1])<=520))
                    {    if (wr1!=0)
                    {    //alert(Number(datas[ts1]));
                        numnew= Number(datas[ts1]);
                    }
                    }
                    else {}
                    ts1=ts1+1;
                }//while
//alert(point);
//alert("undone!");
                /*var sizep = size;
                 window.location.reload();
                 size=sizep;*/
                Tian_chong();
            }
        }//function
    });
}
function mouseWheel(fun){
	(/firefox/i).test(navigator.userAgent)?document.getElementsById("cv").addEventListener("DOMMouseScroll",fun,false):document.getElementsById("cv").onmousewheel=fun;
	}
function bbimg(o){
//var zoom = parseInt(o.style.zoom,10)||100;
//zoom+=event.wheelDelta/12;
//if(zoom>0) o.style.zoom=zoom+'%';
//size=Math.pow(zoom/100,2);
    if(event.wheelDelta>0){zoomin();}
    else{zoomout();}
    Tian_chong();
    return false;
}

</script>
<style type="text/css">
    #p0 {font-weight:bold;
        background:#f6f6f6;
        border: 1px solid #cccccc;
        color: #1c94c4;
        margin-top:20px;
        margin-left:30px;
        float:left;

        border: 1px solid #cccccc;
        height:23px;
        width:60px;
        margin-top:0px;}
    #p1 {font-weight:bold;/*9.26 cmy*/
        background:#0F9217;
        border: 1px solid #cccccc;
        color: #ffffff;
        margin-left:0px;
        height:30px;
        margin-top:5px;}
    #cancelBtn{

        font-weight:bold;/*10.08 cmy*/
        background:#0F9217;
        border: 1px solid #cccccc;
        color: #ffffff;
        margin-left:0px;
        height:30px;
        margin-top:5px;
    }

    #p2{/*10.7 cmy*/
        font-weight:bold;
        background:#0F9217;
        border: 1px solid #cccccc;
        color: #ffffff;
        margin-left:50px;
        float:left;
        height:23px;
        margin-right:20px;
        margin-bottom:10px;}

    #btn-1{
        font-weight:bold;
        background:#0F9217;
        border: 1px solid #cccccc;
        color: #ffffff;
        margin-left:50px;
        margin-top:19px;
        height:23px;
        width:85px;
        float:left;
        margin-bottom:10px;}

    #btn-2{
        font-weight:bold;
        background:#0F9217;
        border: 1px solid #cccccc;
        color: #ffffff;
        margin-left:50px;
        height:23px;
        float:left;
        margin-bottom:10px;}

    #btn-3{
        font-weight:bold;
        background:#0F9217;
        border: 1px solid #cccccc;
        color: #ffffff;
        margin-left:50px;
        margin-top:0px;
        height:23px;
        float:left;
        margin-bottom:10px;}

    #btn-4{
        font-weight:bold;
        background:#f6f6f6;
        border: 1px solid #cccccc;
        color: #1c94c4;
        margin-left:50px;
        height:23px;
        float:left;
        margin-bottom:10px;}

    #btn-7{
        font-weight:bold;
        background:#0F9217;
        border: 1px solid #cccccc;
        color: #ffffff;
        margin-left:50px;
        height:23px;
        float:left;
        margin-bottom:10px;}

    #btn-8{
        font-weight:bold;
        background:#0F9217;
        border: 1px solid #cccccc;
        color: #ffffff;
        margin-left:50px;
        height:23px;
        float:left;
        margin-bottom:10px;}

    #btn-9{
        font-weight:bold;
        background:#0F9217;
        border: 1px solid #cccccc;
        color: #ffffff;
        margin-left:50px;
        float:left;
        height:23px;
        margin-right:20px;
        margin-bottom:10px;}
    #btn-10{
        font-weight:bold;
        background:#0F9217;
        border: 1px solid #cccccc;
        color: #ffffff;
        margin-left:50px;
        height:23px;
        float:left;
        margin-bottom:10px;}

    #btn-11{
        font-weight:bold;
        background:#0F9217;
        border: 1px solid #cccccc;
        color: #ffffff;
        margin-left:50px;
        height:23px;
        float:left;
        margin-bottom:10px;}
    #btn-12{
        font-weight:bold;
        background:#0F9217;
        border: 1px solid #cccccc;
        color: #ffffff;
        margin-left:50px;
        height:23px;
        float:left;
        margin-bottom:10px;}
        
    .overlay{/*10.7 cmy*/
        position:absolute;
        top:150px;
        left:400px;
        right:0;
        bottom:0;
        width:450px;
        height:220px;
        border:5px solid #cccccc;
        background-color:rgba(255,255,255,255);
        display:none;
        z-index:500;

    }
    .overlay.dialog{/*10.7 cmy*/
        position:absolute;
        bottom:0;
        left:0;
        right:0;
        background-color:#efefef;




    }

</style>
</head>
<body onload="init()" oncontextmenu="doNothing()">
	<form enctype="multipart/form-data" method="POST" action="/site/upflow/" id="formid">{% csrf_token %}
        	<input type="file" name="file" /><br />
        	<!--input type="submit" value="上传文件"/-->
        	<input type="button" value="上传文件" onclick = "upfile()"/>
        </form>
	<form enctype="multipart/form-data" method="POST" action="/site/upall/" id="formid1">{% csrf_token %}
                <input type="file" name="file" /><br />
                <!--input type="submit" value="上传文件"/-->
                <input type="button" value="上传文件" onclick = "upfile1()"/>
        </form>
	<div style="width:1288px;height:80px;background:#0F9217;">
		<table>
		<tr>
						<th>
				<img src="http://166.111.68.91/Images/chip.jpg" width="203" height="74"/>
			</th>

			<th>	
				<h1 style="font-family:verdana;">                 BioCAD</h1>		
			</th>
<th>
	<h2 style="font-size:80%">Computer Aided Design</h2>
</th>
			<th width="500" align="right">
			<img src="http://www.tsinghua.edu.cn/publish/newthu/images/logo.png" />
		</th>
		</tr>
	</table>
	</div>
<div style="overflow:hidden;width:1250px;height:520px;position:relative;padding:15px;"onmouseover="document.getElementById('pp').style.display='block';
	document.getElementById('btn-1').style.display='block';
	document.getElementById('btn-2').style.display='block';
	document.getElementById('btn-3').style.display='block';
	document.getElementById('btn-4').style.display='block';
	document.getElementById('btn-7').style.display='block';
	document.getElementById('btn-8').style.display='block';
	document.getElementById('btn-9').style.display='block';
	//document.getElementById('p2').style.display='block';
	document.getElementById('btn-10').style.display='block';
//"onmouseout="document.getElementById('pp').style.display='none';
	document.getElementById('btn-1').style.display='none';
	document.getElementById('btn-2').style.display='none';
	document.getElementById('btn-3').style.display='none';
	document.getElementById('btn-4').style.display='none';
	document.getElementById('btn-7').style.display='none';
	document.getElementById('btn-8').style.display='none';
	document.getElementById('btn-9').style.display='none';
	document.getElementById('btn-10').style.display='none';
	//document.getElementById('p2').style.display='none';">
    <!--cmy9.26-->
    <div id="controlcanvas" width ="800" height="600" style="position:absolute;left:0px;top:0px;border:4px solid #cccccc;" >
        <canvas id="canvas" width="850" height="520" style="position:absolute;left:0px;top:0px;opacity:0.7;" onmousewheel="return bbimg(this)">   </canvas>
    </div>

    <div id="flowcanvas" width ="800" height="600" style="position:absolute;left:0px;top:0px;border:4px solid #cccccc;" >
    <canvas id="canvas2" width="850" height="520"  style="position:absolute;left:0px;top:0px;opacity:0.5;" onmousewheel="return bbimg(this)">   </canvas>
</div>


    <div  style="margin-top:550px;"></div><!--9.26 cmy-->

    <div id="pp"style="position:absolute;margin-top: -100px; padding: 15px;
	height:50px;z-index:200;opacity:0.7;width: 1000px;">
	
	<button id="btn-10" name="10" onmouseover="document.getElementById('btn-10').style.color='#c77405';
        	document.getElementById('btn-10').style.background='#fdf5ce'"
                onmouseout="document.getElementById('btn-10').style.color='#ffffff';
        	document.getElementById('btn-10').style.background='#0F9217'" onclick="uploaddialog()"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="20" height="17" viewBox="0 0 32 32">

<path fill="#444444" d="M18 8l-4-4h-14v26h32v-22h-14zM16 15l7 7h-5v8h-4v-8h-5l7-7z"></path>
</svg></button>
       
        <button id="btn-2" name="2" onmouseover="document.getElementById('btn-2').style.color='#c77405';document.getElementById('btn-2').style.background='#fdf5ce'" onmouseout="document.getElementById('btn-2').style.color='#ffffff';document.getElementById('btn-2').style.background='#0F9217'" onclick="zoomin()"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="20" height="17" viewBox="0 0 32 32">
<path fill="#444444" d="M31.008 27.231l-7.58-6.447c-0.784-0.705-1.622-1.029-2.299-0.998 1.789-2.096 2.87-4.815 2.87-7.787 0-6.627-5.373-12-12-12s-12 5.373-12 12 5.373 12 12 12c2.972 0 5.691-1.081 7.787-2.87-0.031 0.677 0.293 1.515 0.998 2.299l6.447 7.58c1.104 1.226 2.907 1.33 4.007 0.23s0.997-2.903-0.23-4.007zM12 20c-4.418 0-8-3.582-8-8s3.582-8 8-8 8 3.582 8 8-3.582 8-8 8zM14 6h-4v4h-4v4h4v4h4v-4h4v-4h-4z"></path>
</svg>
</button>
        <button id="btn-3" name="3" onmouseover="document.getElementById('btn-3').style.color='#c77405';document.getElementById('btn-3').style.background='#fdf5ce'" onmouseout="document.getElementById('btn-3').style.color='#ffffff';document.getElementById('btn-3').style.background='#0F9217'" onclick="zoomout()"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="20" height="17" viewBox="0 0 32 32">
<path fill="#444444" d="M31.008 27.231l-7.58-6.447c-0.784-0.705-1.622-1.029-2.299-0.998 1.789-2.096 2.87-4.815 2.87-7.787 0-6.627-5.373-12-12-12s-12 5.373-12 12 5.373 12 12 12c2.972 0 5.691-1.081 7.787-2.87-0.031 0.677 0.293 1.515 0.998 2.299l6.447 7.58c1.104 1.226 2.907 1.33 4.007 0.23s0.997-2.903-0.23-4.007zM12 20c-4.418 0-8-3.582-8-8s3.582-8 8-8 8 3.582 8 8-3.582 8-8 8zM6 10h12v4h-12z"></path>
</svg>
</button>
        <button id="btn-7" name="6" onmouseover="document.getElementById('btn-7').style.color='#c77405';
        	document.getElementById('btn-7').style.background='#fdf5ce'"
                onmouseout="document.getElementById('btn-7').style.color='#ffffff';
        	document.getElementById('btn-7').style.background='#0F9217'" onclick="drag()"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="20" height="17" viewBox="0 0 20 20">
<path id="dr" fill="#000000" d="M17 8c-0.412 0-0.794 0.125-1.113 0.339-0.274-0.779-1.016-1.339-1.887-1.339-0.412 0-0.794 0.125-1.113 0.339-0.274-0.779-1.016-1.339-1.887-1.339-0.364 0-0.706 0.098-1 0.269v-3.269c0-1.103-0.897-2-2-2s-2 0.897-2 2v7.373l-1.346-2.333c-0.261-0.475-0.687-0.813-1.199-0.953-0.499-0.136-1.018-0.064-1.462 0.202-0.907 0.544-1.253 1.774-0.77 2.742 0.030 0.061 0.668 1.368 2.66 5.35 0.938 1.875 1.967 3.216 3.059 3.984 0.857 0.603 1.449 0.634 1.559 0.634h5c0.848 0 1.632-0.245 2.331-0.73 0.676-0.468 1.259-1.152 1.734-2.033 0.939-1.743 1.435-4.246 1.435-7.237 0-1.103-0.897-2-2-2zM16.685 16.763c-0.549 1.021-1.548 2.237-3.185 2.237h-4.99c-0.039-0.003-0.46-0.050-1.095-0.525-0.633-0.474-1.605-1.472-2.638-3.54-2.027-4.054-2.65-5.331-2.656-5.343-0.001-0.002-0.001-0.003-0.002-0.004-0.251-0.503-0.073-1.162 0.389-1.439 0.208-0.125 0.451-0.158 0.685-0.095 0.249 0.068 0.458 0.236 0.587 0.472 0.002 0.003 0.004 0.007 0.006 0.010l1.561 2.705c0.319 0.583 0.678 0.828 1.067 0.729 0.39-0.099 0.587-0.489 0.587-1.157v-7.812c0-0.551 0.449-1 1-1s1 0.449 1 1v6.5c0 0.276 0.224 0.5 0.5 0.5s0.5-0.224 0.5-0.5v-1.5c0-0.551 0.449-1 1-1s1 0.449 1 1v1.5c0 0.276 0.224 0.5 0.5 0.5s0.5-0.224 0.5-0.5v-0.5c0-0.551 0.449-1 1-1s1 0.449 1 1v1.5c0 0.276 0.224 0.5 0.5 0.5s0.5-0.224 0.5-0.5v-0.5c0-0.551 0.449-1 1-1s1 0.449 1 1c0 2.826-0.455 5.165-1.315 6.763z"></path>
</svg></button>
        <button id="btn-8" name="7" onmouseover="document.getElementById('btn-8').style.color='#c77405';document.getElementById('btn-8').style.background='#fdf5ce'"  onmouseout="document.getElementById('btn-8').style.color='#ffffff';document.getElementById('btn-8').style.background='#0F9217'" onclick="adapt()"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="20" height="17" viewBox="0 0 32 32">
<path fill="#444444" d="M28 0h-28v32h32v-28l-4-4zM16 4h4v8h-4v-8zM28 28h-24v-24h2v10h18v-10h2.343l1.657 1.657v22.343z"></path>
</svg></button>
        <button id="btn-9" name="8" onmouseover="document.getElementById('btn-9').style.color='#c77405';document.getElementById('btn-9').style.background='#fdf5ce'"  onmouseout="document.getElementById('btn-9').style.color='#ffffff';document.getElementById('btn-9').style.background='#0F9217'" onclick="undo()"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="20" height="17" viewBox="0 0 32 32">
<path fill="#444444" d="M16 2c-4.418 0-8.418 1.791-11.313 4.687l-4.686-4.687v12h12l-4.485-4.485c2.172-2.172 5.172-3.515 8.485-3.515 6.627 0 12 5.373 12 12 0 3.584-1.572 6.801-4.063 9l2.646 3c3.322-2.932 5.417-7.221 5.417-12 0-8.837-7.163-16-16-16z"></path>
</svg></button>

        <form action="/site/ddd/" method="get">{% csrf_token %}<!--10.7 cmy!-->

            <button type="submit" name="s_thread" class="btn btn-primary " id="p2"  onmouseover="document.getElementById('p2').style.color='#c77405';document.getElementById('p2').style.background='#fdf5ce'"
                    onmouseout="document.getElementById('p2').style.color='#ffffff';
        	document.getElementById('p2').style.background='#0F9217'"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="20" height="17" viewBox="0 0 32 32">
<path fill="#444444" d="M18 8l-4-4h-14v26h32v-22h-14zM16 27l-7-7h5v-8h4v8h5l-7 7z"></path>
</svg></button>

        </form>
   </div>



<div style="position:absolute;top:0px;left:1000px;">
<label><input name="11" type="checkbox" value="" onclick="flow_layer(this)"/>Flow Layer</label>
<label><input name="12" type="checkbox" value="" onclick="control_layer(this)"/>Control Layer</label>

</div>

</div>


<div class="overlay" id="overlay"><!--10.7 cmy!-->
    <div style="height:16px;"></div>
    <div class="dialog" style="padding:0 0 0 13px;">

        <label>  文件上传:</label>
        <div style="height:18px;"></div>

        <form id="form1" enctype="multipart/form-data" method="post" action="/site/upload" id="formid">{% csrf_token %}
            <div style="height:90px;">
                <div class="row">
                    <label for="file">  Select a File to Upload:</label>
                    <div style="height:5px;"></div>
                    <input type="file" name="file" id="file" onchange="fileSelected();"/>
                </div>
                <div id="fileName"></div>
                <div id="fileSize"></div>
                <div id="fileType"></div>

            </div>

            <div style="padding:5px 13px 10px 0;">
                <table width="100%">
                    <tr>
                        <td style="height:23px;text-align:right;padding:0 15px 0 0;">
                            <div class="row">
                                <input type="button" onclick="upload()" class="btn btn-primary" value="upload" id="p1" onmouseover="p1.style.color='#c77405';
        p1.style.background='#fdf5ce'" onmouseout="p1.style.color='#ffffff';p1.style.background='#0F9217'"/>

                            </div>
                        </td>
                        <td style="height:25px;padding:0 0 0 15px;"><button id="cancelBtn" onclick="closedialog()" onmouseover="cancelBtn.style.color='#c77405';
        cancelBtn.style.background='#fdf5ce'" onmouseout="cancelBtn.style.color='#ffffff';cancelBtn.style.background='#0F9217'">cancel</button></td>
                    </tr>
                    <tr>
                        <td style="height:25px;"><div id="progressNumber"></div></td>
                    </tr>
                </table>
            </div>
        </form>
	<!--
	<form enctype="multipart/form-data" method="POST" action="/site/upflow/" id="formid">{% csrf_token %}
   	<input type="file" name="file" />
   	<br />
   	<!--input type="submit" value="上传文件"/-->   
   	<input type="button" value="上传文件" onclick = "upfile"/> 
	</form>
	-->
    </div>
</div>

</body>
</html>
